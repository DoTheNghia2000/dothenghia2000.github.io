<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JavaScript Camera</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.8.2/css/bulma.min.css">
  <script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
  <style>

  </style>
</head>

<body>
  <section class="section">
    <div class="container">
      <div class="columns">
        <div class="column is-four-fifths" style="width: 50%;">
          <h1 class="title">
            Camera
          </h1>
          <video autoplay id="video"></video>
          <br>
          <button class="button is-hidden" id="btnPlay">
            <span class="icon is-small">
              <i class="fas fa-play"></i>
            </span>
          </button>
          <button class="button" id="btnPause">
            <span class="icon is-small">
              <i class="fas fa-pause"></i>
            </span>
          </button>
          <button class="button is-success" id="btnScreenshot">
            <span class="icon is-small">
              <i class="fas fa-camera"></i>
            </span>
          </button>
          <button class="button" id="btnChangeCamera">
            <span class="icon">
              <i class="fas fa-sync-alt"></i>
            </span>
            <span>Đổi camera</span>
          </button>
        </div>
        <div class="column">

          <button class="button" id="btnSaveImage" style="display:none;">
            <span>Lưu ảnh</span>
          </button>
        </div>
      </div>
    </div>
  </section>

  <canvas class="is-hidden" id="canvas"></canvas>
  <input type="file" id="environment" capture="environment" accept="image/*" onchange="readFile(event)">
  <!-- <input
    type="file"
  >
  <input type="file" onchange="onImageChange(event)"/>

  <pre id="result"></pre> -->

  <button id="open">Open</button>
  <button id="check_location">check location</button>
  <div class="location"></div>
  <div class="text_size" style="font-size: 20px;">

  </div>
  <div class="text_w_h" style="font-size: 20px;">

  </div>
  <h2 class="title">Hình ảnh</h2>
  <div id="screenshots"><img src="" alt=""></div>
  <input type="button" value="Say hello" id="butOpenFile" />
  <input type=button onClick="asyncs().then((value) => {  console.log(value) })" value='Users'>

  <script>
    let prmoise_location;
    async function asyncs() {
      return promise.then(() => { return true }).catch(()=>{return false})
    }
    const promise = new Promise((resolve, reject) => {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          function () {
            console.log(true)
            resolve()
          },
          function () {
            console.log(false)
            reject()
          }
        );
      } else {
        reject()
        console.log(false)
      }
    })
    asyncs().then((value) => {  console.log(value) })
    // promise.then(() => { console.log('then') }).catch(()=>{console.log('catch')})

    //     function onImageChange(event) {
    //     const imageFile = URL.createObjectURL(event.target.files[0]);
    //     createImage(imageFile, convertImage);
    // }

    // function createImage(imageFile, callback) {
    //   const image = document.createElement('img');
    //   image.onload = () => callback(image);
    //   image.setAttribute('src', imageFile);
    // }

    // function convertImage(image) {
    //   const canvas = drawImageToCanvas(image);
    //   const ctx = canvas.getContext('2d');

    //   let result = [];
    //   for (let y = 0; y < canvas.height; y++) {
    //     result.push([]);
    //     for (let x = 0; x < canvas.width; x++) {
    //       let data = ctx.getImageData(x, y, 1, 1).data;
    //       result[y].push(data[0]);
    //       result[y].push(data[1]);
    //       result[y].push(data[2]);
    //     }
    //   }

    //   const arrayCode = `
    //     #define IMAGE_WIDTH ${canvas.width}
    //     #define IMAGE_HEIGHT ${canvas.height}
    //     #define BYTES_PER_PIXEL 3
    //     uint8_t imageData[IMAGE_HEIGHT][IMAGE_WIDTH * BYTES_PER_PIXEL] = `+convertArray(result)+`;
    //   `;
    //   document.getElementById('result').innerHTML = arrayCode;
    //   let x= [];

    //   console.log(convertArray(result));

    //   const screenshotsContainer = document.querySelector("#screenshots img");
    //   screenshotsContainer.src = "data:image/png;base64," + btoa(String.fromCharCode.apply(null, new Uint8Array(convertArray(result))));


    // }

    // function drawImageToCanvas(image) {
    //   const canvas = document.createElement('canvas');
    //   canvas.width = image.width;
    //   canvas.height = image.height;
    //   canvas.getContext('2d').drawImage(image, 0, 0, image.width, image.height);
    //   return canvas;
    // }

    // function convertArray(array) {
    //   return JSON.stringify(array).replace(/\[/g, '{').replace(/\]/g, '}');
    // }
    //     const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    //     function showAndroidToast(toast) {
    //         Android.showToast(toast);
    //     }
    //     let fileHandle;
    // document.getElementById('butOpenFile').addEventListener('click', async () => {
    //   // Destructure the one-element array.
    //   [fileHandle] = await window.showOpenFilePicker();
    //   // Do something with the file handle.
    // });
    //choose file
    // function readFile(e){
    //   var file = e.target.files[0];
    //   const reader = new FileReader();

    //     reader.addEventListener("load", () => {
    //         // convert image file to base64 string
    //         const screenshotsContainer = document.querySelector("#screenshots");
    //         const img = document.createElement("img");
    //         img.src = reader.result;
    //         getImageDimensions(reader.result)
    //         screenshotsContainer.innerHTML = "";
    //         screenshotsContainer.append(img);


    //     }, false);

    //     if (file) {
    //         reader.readAsDataURL(file);
    //     }

    // }
    const MAX_WIDTH = 720;
    const MAX_HEIGHT = 2160;
    const MIME_TYPE = "image/jpeg";
    const QUALITY = 0.9;
    function readFile(e) {
      const file = e.target.files[0]; // get the file
      const blobURL = URL.createObjectURL(file);
      const img = new Image();
      img.src = blobURL;
      img.onerror = function () {
        URL.revokeObjectURL(this.src);
        // Handle the failure properly
        console.log("Cannot load image");
      };
      img.onload = function () {
        URL.revokeObjectURL(this.src);
        const [newWidth, newHeight] = calculateSize(img, MAX_WIDTH, MAX_HEIGHT);
        const canvas = document.createElement("canvas");
        const screenshotsContainer = document.querySelector("#screenshots");
        const text_w_h = document.querySelector('.text_w_h');
        text_w_h.append('imgWidth: ' + img.naturalWidth + ' , ' + 'imgHeight: ' + img.naturalHeight)
        text_w_h.appendChild(document.createElement("br"))
        text_w_h.append('imgWidth: ' + newWidth + ' , ' + 'imgHeight: ' + newHeight)
        text_w_h.appendChild(document.createElement("br"))
        canvas.width = newWidth;
        canvas.height = newHeight;
        // canvas.width = img.naturalWidth;
        // canvas.height = img.naturalHeight;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, newWidth, newHeight);
        // ctx.drawImage(img, 0, 0, img.naturalWidth, img.naturalHeight);
        function fillTextStroked(text, x, y) {
          ctx.font = "18pt Arial";
          ctx.strokeStyle = '#000000';
          ctx.lineWidth = 2;
          ctx.strokeText(text, x, y);
          ctx.fillStyle = '#ffffff';
          ctx.fillText(text, x, y);
        }
        fillTextStroked("Mã KH - Tên KH: " + "customerCodeName", 10, 20);
        fillTextStroked("Kênh - Địa chỉ: " + "Sub_RE" + '-' + "Address nghia asfasdfw3rfw asgasgeqfweg adsgadsgsdfg svds gbe w fwe g sdg hwe g sdh bs hsd g vs vweeghwsdh ", 10, 40);
        fillTextStroked("Tọa độ: " + "geocode", 10, 60);
        fillTextStroked("CTrình: " + "TradeProgramName", 10, 80);
        fillTextStroked("Ngày chụp: " + "date", 10, 100);
        canvas.toBlob(
          (blob) => {
            // Handle the compressed image. es. upload or save in local state
            displayInfo('Original file', file);
            displayInfo('Compressed file', blob);
          },
          MIME_TYPE,
          QUALITY
        );
        const imagee = document.createElement("img");
        imagee.src = canvas.toDataURL(MIME_TYPE, QUALITY);
        screenshotsContainer.innerHTML = "";
        screenshotsContainer.append(imagee);
      };
    };

    function calculateSize(img, maxWidth, maxHeight) {
      let width = img.width;
      let height = img.height;
      let w = 1400/ img.width;
      let h = 1400 / img.height;
      if (w > h) {
        width = h * width;
        height = h * height;
      } else {
        width = w * width;
        height = w * height;
      }
      // calculate the width and height, constraining the proportions
      // if (width > height) {
      //   if (width > maxWidth) {
      //     height = Math.round((height * maxWidth) / width);
      //     width = maxWidth;
      //   }
      // } else {
      //   if (height > maxHeight) {
      //     width = Math.round((width * maxHeight) / height);
      //     height = maxHeight;
      //   }
      // }
      return [width, height];
    }

    // Utility functions for demo purpose

    function displayInfo(label, file) {
      const p = document.createElement('p');
      p.innerText = `${label} - ${readableBytes(file.size)}`;
      const text_size = document.querySelector('.text_size');
      text_size.append(p);
    }

    function readableBytes(bytes) {
      const i = Math.floor(Math.log(bytes) / Math.log(1024)),
        sizes = ['B', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];

      return (bytes / Math.pow(1024, i)).toFixed(2) + ' ' + sizes[i];
    }

    // function getImageDimensions(file) {
    //   var i = new Image();
    //   i.onload = function(){
    //     const canvas = document.createElement("canvas");
    //     const text_w_h = document.querySelector('.text_w_h');
    //     text_w_h.innerHTML = 'imgWidth: '+ i.naturalWidth + ' , '+ 'imgHeight: '+ i.naturalHeight;
    //     canvas.width = i.naturalWidth;
    //     canvas.height = i.naturalHeight;
    //     const ctx = canvas.getContext("2d");
    //     ctx.drawImage(i, 0, 0, i.naturalWidth, i.naturalHeight);
    //     function fillTextStroked(text, x, y) {
    //       ctx.font = "14pt Arial";
    //       ctx.strokeStyle = '#000000';
    //       ctx.lineWidth = 2;
    //       ctx.strokeText(text, x, y);
    //       ctx.fillStyle = '#ffffff';
    //       ctx.fillText(text, x, y);
    //     }
    //     fillTextStroked("Mã KH - Tên KH: " + "customerCodeName", 10, 20);
    //     fillTextStroked("Kênh - Địa chỉ: " + "Sub_RE" + '-' + "Address nghia asfasdfw3rfw asgasgeqfweg adsgadsgsdfg svds gbe w fwe g sdg hwe g sdh bs hsd g vs vweeghwsdh ", 10, 40);
    //     fillTextStroked("Tọa độ: " + "geocode", 10, 60);
    //     fillTextStroked("CTrình: " + "TradeProgramName", 10, 80);
    //     fillTextStroked("Ngày chụp: " + "date", 10, 100);
    //     canvas.toBlob(
    //       (blob) => {
    //         // Handle the compressed image. es. upload or save in local state
    //         displayInfo('Original file', file);
    //         // displayInfo('Compressed file', blob);
    //       },
    //       // MIME_TYPE,
    //       // QUALITY
    //     );
    //     i.src = canvas.toDataURL("image/png");
    //   };
    //   i.src = file;
    // }
    (function () {
      if (
        !"mediaDevices" in navigator ||
        !"getUserMedia" in navigator.mediaDevices
      ) {
        alert("Camera API is not available in your browser");
        return;
      }

      let videoStream;
      // video constraints
      const constraints = {
        video: {
          width: {
            min: 1280,
            ideal: 1920,
            max: 2560,
          },
          height: {
            min: 720,
            ideal: 1080,
            max: 1440,
          },
        },
      };
      // initialize
      async function initializeCamera() {
        videoStream = await navigator.mediaDevices.getUserMedia(constraints);
      }


      initializeCamera().then(function () {
        //open camera
        document.getElementById('open').onclick = function () {
          // if (isMobile) {
          //Chạy khi được truy cập bằng điện thoại
          console.log('mobile');

          // const btnScreenshot = document.querySelector("#btnScreenshot");
          // btnScreenshot.addEventListener("click", function () {

          //         const img = document.querySelector("#screenshots img");
          //         const canvas = document.querySelector("#canvas");
          //         var context = canvas.getContext('2d');
          //         context.drawImage(img, 0, 0);

          //         function fillTextStroked(text, x, y) {
          //           context.font = "14pt Arial";
          //           context.strokeStyle = '#000000';
          //           context.lineWidth = 2;
          //           context.strokeText(text, x, y);
          //           context.fillStyle = '#ffffff';
          //           context.fillText(text, x, y);
          //         }
          //         fillTextStroked("Mã KH - Tên KH: " + "customerCodeName", 10, 20);
          //         fillTextStroked("Kênh - Địa chỉ: " + "Sub_RE" + '-' + "Address", 10, 40);
          //         fillTextStroked("Tọa độ: " + "geocode", 10, 60);
          //         fillTextStroked("CTrình: " + "TradeProgramName", 10, 80);
          //         fillTextStroked("Ngày chụp: " + "date", 10, 100);

          //         img.src = canvas.toDataURL("image/png");

          // })
          document.getElementById('environment').click();
          // }else{
          //   //Chạy khi được truy cập bằng máy tính
          //   (function () {
          //     if (
          //         !"mediaDevices" in navigator ||
          //         !"getUserMedia" in navigator.mediaDevices
          //     ) {
          //         alert("Camera API is not available in your browser");
          //         return;
          //     }

          //     // get page elements
          //     let data_image ;
          //     const video = document.querySelector("#video");
          //     const btnPlay = document.querySelector("#btnPlay");
          //     const btnPause = document.querySelector("#btnPause");
          //     const btnScreenshot = document.querySelector("#btnScreenshot");
          //     const btnChangeCamera = document.querySelector("#btnChangeCamera");
          //     const btnSaveImage = document.querySelector('#btnSaveImage')
          //     const screenshotsContainer = document.querySelector("#screenshots");
          //     const canvas = document.querySelector("#canvas");
          //     const devicesSelect = document.querySelector("#devicesSelect");

          //     // video constraints
          //     const constraints = {
          //         video: {
          //         width: {
          //             min: 1280,
          //             ideal: 1920,
          //             max: 2560,
          //         },
          //         height: {
          //             min: 720,
          //             ideal: 1080,
          //             max: 1440,
          //         },
          //         },
          //     };

          //     // use front face camera
          //     let useFrontCamera = true;

          //     // current video stream
          //     let videoStream;

          //     // handle events
          //     // play
          //     btnPlay.addEventListener("click", function () {
          //         video.play();
          //         btnPlay.classList.add("is-hidden");
          //         btnPause.classList.remove("is-hidden");
          //     });

          //     // pause
          //     btnPause.addEventListener("click", function () {
          //         video.pause();
          //         btnPause.classList.add("is-hidden");
          //         btnPlay.classList.remove("is-hidden");
          //     });

          //     // take screenshot
          //     btnScreenshot.addEventListener("click", function () {
          //         const img = document.createElement("img");
          //         canvas.width = video.videoWidth;
          //         canvas.height = video.videoHeight;
          //         var context = canvas.getContext('2d');
          //         context.drawImage(video, 0, 0);
          //         function fillTextStroked(text, x, y) {
          //           context.font = "14pt Arial";
          //           context.strokeStyle = '#000000';
          //           context.lineWidth = 2;
          //           context.strokeText(text, x, y);
          //           context.fillStyle = '#ffffff';
          //           context.fillText(text, x, y);
          //         }
          //         fillTextStroked("Mã KH - Tên KH: " + "customerCodeName", 10, 20);
          //         fillTextStroked("Kênh - Địa chỉ: " + "Sub_RE" + '-' + "Address", 10, 40);
          //         fillTextStroked("Tọa độ: " + "geocode", 10, 60);
          //         fillTextStroked("CTrình: " + "TradeProgramName", 10, 80);
          //         fillTextStroked("Ngày chụp: " + "date", 10, 100);


          //         img.src = canvas.toDataURL("image/png");
          //         data_image = canvas.toDataURL("image/png");
          //         btnSaveImage.style.display = "block";
          //         screenshotsContainer.innerHTML = "";
          //         screenshotsContainer.append(img);
          //     });

          //     // switch camera
          //     btnChangeCamera.addEventListener("click", function () {
          //         useFrontCamera = !useFrontCamera;

          //         initializeCamera();
          //     });

          //     // stop video stream
          //     function stopVideoStream() {
          //         if (videoStream) {
          //         videoStream.getTracks().forEach((track) => {
          //             track.stop();
          //         });
          //         }
          //     }

          //     // initialize
          //     async function initializeCamera() {
          //         stopVideoStream();
          //         constraints.video.facingMode = useFrontCamera ? "user" : "environment";

          //         try {
          //         videoStream = await navigator.mediaDevices.getUserMedia(constraints);
          //         video.srcObject = videoStream;
          //         } catch (err) {
          //         alert("Could not access the camera");
          //         }
          //     }

          //     initializeCamera();
          // })();
          //   console.log('web');
          // }
        }
      }).catch(function () {
        document.getElementById('open').onclick = function () {
          alert("Could not access the camera");
        };
      });
    })();
    function get_location() {
      prmoise_location = new Promise((resolve, reject) => {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            function (position) {
              console.log(true)
              resolve(position)
            },
            function (position) {
              console.log(false)
              reject(position)
            }
          );
        } else {
          console.log(false)
          reject()
        }
      })
    }
    document.getElementById('check_location').onclick = function () {
      get_location();
      prmoise_location.then((position) => {
        // if(position.code == null){
        //   document.querySelector('.location').innerHTML = "Latitude: " + position.coords.latitude +' '+"Longitude: " + position.coords.longitude;
        // }else{
        //   document.querySelector('.location').innerHTML = 'false';
        // }
        document.querySelector('.location').innerHTML = position;
        console.log(position)
      }).catch((position) => {
        if (position.code != null) {
          document.querySelector('.location').innerHTML = 'false';
        }
        console.log(position.code)
      })
    }

  </script>
</body>

</html>
